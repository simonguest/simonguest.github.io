<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Moving VHDs to the Cloud - simonguest.com
    </title>
    <link rel="alternate" href="feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Moving VHDs to the Cloud</h1>
        <p class="author">Written by <span class="author">Simon Guest</span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>When I speak with customers about cloud computing, a common question is often “how do I migrate an application to the cloud?”  While this is a multi-part answer, one of the hurdles for migration is often&nbsp;storage. </p>
<p>Many applications store data using the file system (e.g. read / write a file to d:dataconfig.xml).  Moving these types of applications to the cloud can be difficult as the storage mechanisms in the cloud are somewhat&nbsp;different. </p>
<p><span class="more"></span></p>
<p>To help address this problem, in Feb 2010 we released v1.1 of the <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=5664019e-6860-4c33-9843-4eb40b297ab6&amp;DisplayLang=en">Windows Azure <span class="caps">SDK</span></a> which supports a new feature call Cloud Drives.  A Cloud Drive is the ability to mount a virtual drive in the cloud so that applications can write to it as they would a local drive.  This cloud drive is persisted so that even if the machine goes down, the data is not&nbsp;lost.</p>
<p>What many people don’t realize however is that the format that the Cloud Drive uses is interchangeable with the <span class="caps">VHD</span> (Virtual Hard Drive) format used by virtualization products such as Hyper-V, Virtual PC, Windows Server, and Windows 7.  What this means is that you can create a single VHD, use it locally on a Windows PC, attach it to a virtualized image, and now copy it to the cloud and access it there also.  As you can imagine, for anyone looking to migrate applications to the cloud, this opens up a world of&nbsp;possibilities.</p>
<p>In this post, I’ll walk through a series of steps that show creating a <span class="caps">VHD</span> from scratch, copying it to the cloud, and accessing it from a web role running in&nbsp;Azure.</p>
<p><strong>Before you&nbsp;begin</strong></p>
<p>You’ll of course need an Azure account.  If you don’t have one, you can go <a href="http://www.microsoft.com/windowsazure/account/">here</a> to sign&nbsp;up.</p>
<p>Once you have your account, you’ll need to setup two new&nbsp;services. </p>
<p><img src="/articles/moving-vhds-to-the-cloud/image.png" alt="image"> </p>
<p>You’ll need to create a storage account – this is where the VHDs will be stored – and a hosted service to run your application from.  When you set them up, make sure that they are created in the same geography (i.e. don’t have your storage account in Asia, and your hosted service in the <span class="caps">US</span> as the drive mounting has to be in the same&nbsp;region).</p>
<p>Once you have your storage account and service created, you are ready to create and upload your&nbsp;<span class="caps">VHD</span>. </p>
<p><strong>Step 1.  You’ll need a&nbsp;<span class="caps">VHD</span></strong></p>
<p>If you already have a <span class="caps">VHD</span> file that you would like to use, you can skip to Step 2.  You’ll be copying this VHD to the cloud, so you may want to choose a smaller VHD file for test&nbsp;purposes.</p>
<p>If you are running Windows 7, creating a new <span class="caps">VHD</span> is&nbsp;easy. </p>
<p>Firstly, go to the start menu and type <strong>disk management</strong>. </p>
<p>From the start menu click on <strong>Create and format hard disk&nbsp;partitions</strong></p>
<p><img src="/articles/moving-vhds-to-the-cloud/image1.png" alt="image"></p>
<p>This will open up the disk management tool.  From the <strong>Action</strong> menu, select <strong>Create <span class="caps">VHD</span></strong>.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image2.png" alt="image"></p>
<p>Enter a location for the <span class="caps">VHD</span> file and a size.  The minimum is 16Mb and the maximum is likely the amount of free disk space on your&nbsp;machine. </p>
<p><img src="/articles/moving-vhds-to-the-cloud/image3.png" alt="image"> </p>
<p>When your disk appears in the management tool, right click on the disk name and select <strong>Initialize Disk</strong>.  Select the default (<span class="caps">MBR</span>) and select&nbsp;OK.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image4.png" alt="image"></p>
<p>After initialization, right click on the disk and create a <strong>New Simple Volume</strong>.  Walk through the wizard, accepting the defaults and assign a drive letter to the <span class="caps">VHD</span>.  Finally, format the disk using NTFS (a quick format is fine).  If a dialog box appears asking you to format the disk (sometimes the disk gets detected just before formatting has begun), just hit&nbsp;cancel.</p>
<p>After this is done, you can open the drive and access it as you would any other drive. Add some files and folders,&nbsp;etc.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image5.png" alt="image"> </p>
<p>When you are ready to upload to the cloud, you’ll need to detach the drive.  To do this, go back in to the disk management tool, right click on the disk name and select <strong>Detach <span class="caps">VHD</span></strong>.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image6.png" alt="image"></p>
<p>(Do not select the Delete the virtual hard disk file checkbox – otherwise, they’ll be nothing to&nbsp;upload!)</p>
<p><strong>Step 2.  Upload it to Azure&nbsp;Storage</strong></p>
<p>The next step is to upload the <span class="caps">VHD</span> to the cloud.  The VHD will be stored in something called Blob (Binary Large OBject) storage.  You may have heard of blob storage if you’ve seen any of the introductory Azure presentations.  It’s the type of storage that is used for binary data such as images, videos, and the&nbsp;like.</p>
<p>In February we enabled support for Page Blobs.  Page Blobs are binary objects stored in the cloud that support random read/writes through pages.  This makes them ideal for dealing with <span class="caps">VHD</span> type of access, and this is the format that we’ll be using to upload our VHD to the&nbsp;cloud.</p>
<p>The one caveat of this is that you must use a tool that supports page blobs (most of the tools available today only support regular blobs).  The tool I would recommend is <a href="http://www.cerebrata.com/Products/CloudStorageStudio/Default.aspx">Cloud Storage Studio</a> by Cerebrata as it supports page blobs through a nice&nbsp;interface.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image7.png" alt="image"></p>
<p>Open the tool and access the storage account that you created in the “Before you begin” section earlier in this&nbsp;post. </p>
<p>I would recommend creating a new container for your <span class="caps">VHD</span> images to keep them separate from other content.  As shown in the screenshot above, I’ve created a container called&nbsp;vhd.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image8.png" alt="image"></p>
<p>Select the container, and click on the <strong>Upload Page Blob</strong> button.  There are two upload buttons – you need the one with the icon that includes the page and the up&nbsp;arrow.</p>
<p>Point to the location of your <span class="caps">VHD</span> file and click on the <strong>Upload</strong>&nbsp;button.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image9.png" alt="image"></p>
<p>This might take a little way depending on the size of your <span class="caps">VHD</span> and the speed of your&nbsp;network.</p>
<p>Once you have uploaded the file, validate that it exists by hitting the refresh&nbsp;button.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image10.png" alt="image"></p>
<p>With the <span class="caps">VHD</span> uploaded, we can now move on to creating the cloud application that accesses&nbsp;it.</p>
<p><strong>Step 3.  Accessing the <span class="caps">VHD</span> from Windows&nbsp;Azure </strong></p>
<p>I’m going to assume that you have some knowledge of creating an <span class="caps">ASP</span>.NET application and uploading it to Windows Azure.  If you haven’t done this before, I would recommend checking out the <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=413E88F8-5966-4A83-B309-53B7B77EDF78&amp;displaylang=en">Windows Azure Training Kit</a>.</p>
<p>To access the <span class="caps">VHD</span> in the cloud, we create a webrole and use the following&nbsp;code.</p>
<p>Add reference to the <strong>Microsoft.WindowsAzure.CloudDrive.<span class="caps">DLL</span></strong> that can be found in the <span class="caps">GAC</span> (assuming that you have the <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=dba6a576-468d-4ef6-877e-b14e3c865d3a&amp;displaylang=en">v1.1 <span class="caps">SDK</span></a> installed).  Then, in your webrole, you’ll need to add the following using&nbsp;statements:</p>
<pre><code class="lang-cs"><span class="keyword">using</span> Microsoft.WindowsAzure;
<span class="keyword">using</span> Microsoft.WindowsAzure.ServiceRuntime;
<span class="keyword">using</span> Microsoft.WindowsAzure.StorageClient;
</code></pre>
<p>Here is the code that you should run in your web role.  (You can place this behind a button or&nbsp;something…)</p>
<pre><code class="lang-cs">String accountName = &quot;&quot;;  // insert your storage account name here
String accountKey = &quot;”;  // insert your storage account primary key here
StorageCredentialsAccountAndKey credentials = new StorageCredentialsAccountAndKey(accountName, accountKey);

CloudStorageAccount storageAccount = new CloudStorageAccount(credentials, new Uri(String.Format(&quot;http://{0}.blob.core.windows.net&quot;,accountName)),new Uri(String.Format(&quot;http://{0}.queue.core.windows.net&quot;, accountName)),new Uri(String.Format(&quot;http://{0}.table.core.windows.net&quot;, accountName)));

// initialize the local cache - need to trim the end backslash otherwise, HRESULT=D0000033
LocalResource localCache = RoleEnvironment.GetLocalResource(&quot;LocalCache&quot;);
CloudDrive.InitializeCache(localCache.RootPath.TrimEnd(&#39;&#39;), localCache.MaximumSizeInMegabytes);

// Create and mount the drive
CloudDrive c = storageAccount.CreateCloudDrive(&quot;vhd/myvhd.vhd&quot;);
String driveLetter = c.Mount(localCache.MaximumSizeInMegabytes, DriveMountOptions.None);

// do regular System.IO.File and System.IO.Directory operations here against driveLetter
Response.Write(System.IO.Directory.GetFiles(driveLetter + &quot;&quot;).Count() + &quot; files found on the root of the mounted drive.&quot;);

// unmount the drive
c.Unmount();
</code></pre>
<p>There are five main pieces to the&nbsp;code.</p>
<p>Firstly, the storage account reference is created using the account name and key that you retrieve when you setup your Azure&nbsp;account.</p>
<p>After that we need to initialize a local cache used by the cloud drive.  To create this, insert the following code into your ServiceDefinition.csdef file on your&nbsp;webrole.</p>
<pre><code class="lang-xml"><span class="tag">&lt;<span class="title">LocalResources</span>&gt;</span>
  <span class="tag">&lt;<span class="title">LocalStorage</span> <span class="attribute">name</span>=<span class="value">"LocalCache"</span> <span class="attribute">cleanOnRoleRecycle</span>=<span class="value">"false"</span> <span class="attribute">sizeInMB</span>=<span class="value">"100"</span> /&gt;</span>
<span class="tag">&lt;/<span class="title">LocalResources</span>&gt;</span>
</code></pre>
<p>We then create and mount the drive using the <strong>CreateCloudDrive</strong> and <strong>Mount</strong> methods.  Make sure that the path and name to your <span class="caps">VHD</span> matches what you uploaded in Step&nbsp;2.</p>
<p>Once the drive is mounted we get a drive letter (as a string – e.g. “f:”).  You can then make calls to that drive letter using the regular calls (e.g. <strong>System.<span class="caps">IO</span>.File</strong> and <strong>System.<span class="caps">IO</span>.Directory</strong>).  In a worker role you can even launch applications from the <span class="caps">VHD</span> by spawning a new&nbsp;process. </p>
<p>Finally, to unmount the drive, just call the <strong>Unmount</strong> method to release the <span class="caps">VHD</span>&nbsp;image.</p>
<p><img src="/articles/moving-vhds-to-the-cloud/image11.png" alt="image"> </p>
<p>There are a lot of details behind the scenes that I’m not going to go into here (e.g. read and read/write access to the <span class="caps">VHD</span>)  - if you want to learn more, I would recommend checking out <a href="http://microsoftpdc.com/Sessions/SVC14">this <span class="caps">PDC</span> session</a> by Brad&nbsp;Calder</p>
<p><strong>Appendix.  Running this in a local development&nbsp;environment.</strong></p>
<p>You should note that uploading a <span class="caps">VHD</span> only works using a live deployment in the cloud.  In the local development fabric, you’ll find that you cannot access a remote VHD (you’ll get a HRESULT = 80070003 error).  Also, you can’t upload a page blob to local development&nbsp;storage.</p>
<p>However, you can still duplicate the same functionality in the local development environment by using this&nbsp;code:</p>
<pre><code class="lang-cs"><span class="comment">// Setup the account details</span>
CloudStorageAccount storageAccount = CloudStorageAccount.DevelopmentStorageAccount;
<span class="comment">// initialize the local cache - need to trim the end backslash otherwise, <span class="caps">HRESULT</span>=D0000033</span>
LocalResource localCache = RoleEnvironment.GetLocalResource(<span class="string">"LocalCache"</span>);
CloudDrive.InitializeCache(localCache.RootPath.TrimEnd(<span class="string">''</span>), localCache.MaximumSizeInMegabytes);

<span class="comment">// Create and mount the drive</span>
CloudDrive c = storageAccount.CreateCloudDrive(<span class="string">"vhd/myvhd.vhd"</span>);

<span class="comment">// try creating the drive if it doesn't exist</span>
<span class="keyword">try</span>
{
        c.Create(<span class="number">16</span>);
}
        <span class="keyword">catch</span> (Exception)
{
         <span class="comment">// ignore - <span class="caps">VHD</span> folder already exists</span>
}

String driveLetter = c.Mount(localCache.MaximumSizeInMegabytes, DriveMountOptions.None);

<span class="comment">// do regular System.<span class="caps">IO</span>.File and System.IO.Directory operations here against driveLetter</span>
Response.Write(System.<span class="caps">IO</span>.Directory.GetFiles(driveLetter + <span class="string">""</span>).Count() + <span class="string">" files found on the root of the mounted drive."</span>);

<span class="comment">// unmount the drive</span>
c.Unmount();
</code></pre>
<p>There are a couple of differences from the live&nbsp;environment.</p>
<p>Firstly, instead of using the public account details, we can just make a call to <strong>CloudStorageAccount.DevelopmentStorageAccount</strong>. </p>
<p>Secondly, just before we mount the drive we actually try to create it using the <strong>c.Create(16)</strong> command.  If it already exists, then it throws an exception that we just&nbsp;ignore.</p>
<p>It’s important to know that this doesn’t actually create a <span class="caps">VHD</span> file. Instead, it creates a new directory in this&nbsp;folder:</p>
<p><strong>c:users[username]AppDataLocaldftmpwadddevstoreaccount1vhd</strong></p>
<p>You can now access this folder through Windows Explorer, go into the .vhd folder and add/remove files as you wish.  Once you are ready to move to a production environment you simply copy the files from this directory in to a new <span class="caps">VHD</span> (as created in Step 1), upload, and switch to the production&nbsp;code.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2015 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
            <script type="text/javascript">
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-56671816-1', 'auto');
              ga('send', 'pageview');
              
            </script>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>