<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Using Apple Push Notifications from Windows Azure - simonguest.com
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Using Apple Push Notifications from Windows Azure</h1>
        <p class="author">Written by <span class="author"></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>In my <a href="http:&#x2F;&#x2F;channel9.msdn.com&#x2F;events&#x2F;MIX&#x2F;MIX11&#x2F;EXT18"><span class="caps">MIX11</span> session</a> last week I demonstrated how to create push notifications to iPhone and iPad devices from Wndows Azure.&amp;nbsp; I’ve put together this blog post to share more detail and the source code for how this&nbsp;works.</p>
<p>Firstly, if you haven’t already, you will need to register your iPhone&#x2F;iPad application for push notifications.&amp;nbsp; To do this, log into the iOS developer center (you’ll need to be a registered Apple Developer) and in the provisioning portal setup a new App <span class="caps">ID</span>, enabling it for push notifications.&amp;nbsp; Here’s the App ID for my MIX&nbsp;demo:</p>
<p><a href="http:&#x2F;&#x2F;simonguest.com&#x2F;wp-content&#x2F;uploads&#x2F;2011&#x2F;04&#x2F;image.png"><img src="http:&#x2F;&#x2F;simonguest.com&#x2F;wp-content&#x2F;uploads&#x2F;2011&#x2F;04&#x2F;image_thumb.png &quot;image&quot;" alt="image"></a></p>
<p>With the development certificate that you downloaded during this process, create a new Azure worker role and import the certificate into a folder called “certs”:&amp;nbsp; In addition, you’ll need to configure the properties of the certificate file such that the build action is set to&nbsp;“Content”.</p>
<p><a href="http:&#x2F;&#x2F;simonguest.com&#x2F;wp-content&#x2F;uploads&#x2F;2011&#x2F;04&#x2F;image1.png"><img src="http:&#x2F;&#x2F;simonguest.com&#x2F;wp-content&#x2F;uploads&#x2F;2011&#x2F;04&#x2F;image_thumb1.png &quot;image&quot;" alt="image"></a></p>
<p>(I’ve deliberately skimmed over the previous points of creating and App <span class="caps">ID</span> and Azure Worker role as they are both well documented by Apple and&nbsp;Microsoft).</p>
<p>&amp;nbsp;</p>
<p>To start configuring the worker role for push notifications, first add a reference to the Windows Azure Storage Client (Microsoft.WindowsAzure.StorageClient) library.&amp;nbsp; In the OnRun section of the worker role, access the Azure queue that messages are going to be placed in.&amp;nbsp; 
&lt;pre class=&quot;brush:c-sharp&quot;&gt;StorageCredentials creds = new StorageCredentialsAccountAndKey(&quot;<span class="caps">YOUR</span> ACCOUNT NAME&quot;, &quot;YOUR ACCOUNT&nbsp;KEY&quot;);</p>
<p>CloudQueueClient cqc = new CloudQueueClient(&quot;&quot;<span class="caps">YOUR</span> QUEUE URL”,&nbsp;creds);</p>
<p>var testQueue = cqc.ListQueues().First(q =&amp;gt; q.Name.StartsWith(&quot;<span class="caps">YOUR</span> QUEUE&nbsp;NAME&quot;));&lt;&#x2F;pre&gt;</p>
<p>Then, still within the OnRun method, create a routine that checks the queue for incoming messages and sets up the connection to the <span class="caps">APN</span> (Apple Push Notification)&nbsp;service.</p>
<p>&lt;pre class=&quot;brush:c-sharp&quot;&gt;while (true)
            {&nbsp;Thread.Sleep(10000);</p>
<pre><code>            if (testQueue.RetrieveApproximateMessageCount() != 0)
            {

                List&amp;lt;cloudqueuemessage&amp;gt; messages = testQueue.GetMessages(testQueue.RetrieveApproximateMessageCount()).ToList();
                foreach (CloudQueueMessage message in messages)
                {
                    Trace.WriteLine(&amp;quot;Retrieved message from Queue: &amp;quot; + message.AsString);
                    &amp;#x2F;&amp;#x2F; open the APN connection
                    InitializeAPN();
                    &amp;#x2F;&amp;#x2F; send message
                    string session = message.AsString.Substring(0, message.AsString.IndexOf(&amp;#39;:&amp;#39;));
                    SendAPNMessage(message.AsString, session);
                    &amp;#x2F;&amp;#x2F; tear down the APN connection
                    CloseAPN();

                    testQueue.DeleteMessage(message);
                }
            }
        }
</code></pre><p>&lt;&#x2F;pre&gt;</p>
<p>&lt;p&gt;You’ll probably want to do something a little more elegant than “while (true)” but this works for the purposes of this post.&amp;nbsp; Also, as I mentioned in the talk, you may or may not want to setup and tear down the connection to the <span class="caps">APN</span> for each message that you send.&amp;nbsp; If you are planning to send a large volume of messages to a large number of devices, Apple may view this as a denial of service attack and refuse your connection.&amp;nbsp; A more prescriptive approach in this scenario would be to instead open the connection in the OnStart method and keep it alive during&nbsp;OnRun.</p>
<p>Within the worker role, setup the following declarations.&amp;nbsp; Most of these should be straightforward, and you’ll need to replace a number of them with your own details.&amp;nbsp; 
&lt;pre class=&quot;brush:c-sharp&quot;&gt;private static string <span class="caps">HOST</span> =&nbsp;&quot;gateway.sandbox.push.apple.com&quot;;</p>
<p>private static int <span class="caps">PORT</span> =&nbsp;2195;</p>
<p>private static string CERT_PASSWORD = &quot;<span class="caps">YOUR</span>&nbsp;PASSWORD&quot;;</p>
<p>private static X509Certificate2 CLIENT_CERT = new X509Certificate2(Environment.GetEnvironmentVariable(&quot;RoleRoot&quot;) + @&quot;approotcertsmix11_dev_cert.p12&quot;,&nbsp;CERT_PASSWORD);</p>
<p>private static X509Certificate2Collection CLIENT_CERT_COLLECTION = new&nbsp;X509Certificate2Collection(CLIENT_CERT);</p>
<p>private static string DEVICE_TOKEN = &quot;<span class="caps">YOUR</span> DEVICE TOKEN&quot;;&amp;nbsp; &#x2F;&#x2F;Replace this with the Device token we obtain later on in this&nbsp;example</p>
<p>private TcpClient&nbsp;client;</p>
<p>private SslStream sslStream;&nbsp;&lt;&#x2F;pre&gt;</p>
<p>With these declarations in place, we can now start writing the <span class="caps">APN</span> code.&amp;nbsp; First, create an IntializeAPN method, responsible for setting up the connection to the APN.
&lt;pre class=&quot;brush:c-sharp&quot;&gt;private void&nbsp;InitializeAPN()</p>
<p>{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; client = new TcpClient(<span class="caps">HOST</span>,&nbsp;PORT);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; sslStream = new SslStream(client.GetStream(),&nbsp;false);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;try</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; sslStream.AuthenticateAsClient(<span class="caps">HOST</span>, CLIENT_CERT_COLLECTION, SslProtocols.Tls,&nbsp;false);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; catch (AuthenticationException&nbsp;ex)</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Trace.WriteLine(&quot;Could not open <span class="caps">APN</span> connection: &quot; +&nbsp;ex.ToString());</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; Trace.WriteLine(&quot;<span class="caps">APN</span> connection opened&nbsp;successfully.&quot;);</p>
<p>}</p>
<p>&lt;&#x2F;pre&gt;</p>
<p>Then, create a method called SendAPNMessage which will construct and sent the push notification message in the correct format.&amp;nbsp; 
&lt;pre class=&quot;brush:c-sharp&quot;&gt;private void SendAPNMessage(string message, string&nbsp;session)</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;try</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; MemoryStream memoryStream = new&nbsp;MemoryStream();</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; BinaryWriter binaryWriter = new&nbsp;BinaryWriter(memoryStream);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &#x2F;&#x2F; construct the&nbsp;message</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; binaryWriter.Write((byte)0);&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; binaryWriter.Write((byte)0);&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;binaryWriter.Write((byte)32); </p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &#x2F;&#x2F; convert to hex and&nbsp;write</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; byte[] deviceToken = new byte[DEVICE_TOKEN.Length &#x2F;&nbsp;2];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (int i = 0; i &amp;lt; deviceToken.Length;&nbsp;i++)</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; deviceToken[i] = byte.Parse(DEVICE_TOKEN.Substring(i * 2, 2),&nbsp;System.Globalization.NumberStyles.HexNumber);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;binaryWriter.Write(deviceToken);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &#x2F;&#x2F; construct payload within <span class="caps">JSON</span> message&nbsp;framework</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; String payload = &quot;{&quot;aps&quot;:{&quot;alert&quot;:&quot;&quot; + message +&nbsp;&quot;&quot;,&quot;session&quot;:&quot;&quot;+session+&quot;&quot;,&quot;badge&quot;:1}}&quot;;</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &#x2F;&#x2F; write payload&nbsp;data</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; binaryWriter.Write((byte)0);&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; binaryWriter.Write((byte)payload.Length);&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; byte[] payloadBytes =&nbsp;System.Text.Encoding.<span class="caps">UTF8</span>.GetBytes(payload);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;binaryWriter.Write(payloadBytes);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;binaryWriter.Flush();</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &#x2F;&#x2F; send across the&nbsp;wire</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; byte[] array =&nbsp;memoryStream.ToArray();</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sslStream.Write(array);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sslStream.Flush();</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; catch (Exception&nbsp;ex)</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Trace.WriteLine(ex.ToString());</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Trace.WriteLine(&quot;Message successfully&nbsp;sent.&quot;);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&nbsp;&lt;&#x2F;pre&gt;</p>
<p>You’ll notice that my SendAPNMessage method signature contains a “session” value.&amp;nbsp; For the purposes of the demo, I was sending across the session code that had changed as an explicit value in the notification message.&amp;nbsp; Feel free to change or remove this as you&nbsp;need.</p>
<p>Finally, the close method is called to close the connection.
&lt;pre class=&quot;brush:c-sharp&quot;&gt;private void&nbsp;CloseAPN()</p>
<p>{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;client.Close();</p>
<p>}&lt;&#x2F;pre&gt;</p>
<p>At this point, you might be wondering how you obtain the DEVICE_TOKEN value for the above.&amp;nbsp; This is not the <span class="caps">UDID</span> of the device, but instead a separate token that is generated by the phone itself.&amp;nbsp; To get this token, and to handle incoming push notifications, let’s turn our attention to the XCode project.&amp;nbsp; For my demo I was receiving push notifications within a <a href="http:&#x2F;&#x2F;www.phonegap.com">PhoneGap</a> application, but this code will work equally in a regular native client&nbsp;application.</p>
<p>First, we need to instruct the application to register for <span class="caps">APN</span> messages.&amp;nbsp; This is done using the registerForRemoteNotificationTypes method.&amp;nbsp; You’ll need to call this method when the application first starts up (for PhoneGap projects, this can be in the init method of the AppDelegate).
&lt;pre class=&quot;brush:c&quot;&gt;NSLog(@&quot;Registering for&nbsp;APN&quot;);</p>
<p>[[UIApplication sharedApplication] registerForRemoteNotificationTypes: (UIRemoteNotificationTypeAlert | UIRemoteNotificationTypeBadge |&nbsp;UIRemoteNotificationTypeSound)];</p>
<p>&lt;&#x2F;pre&gt;</p>
<p>This method has three callbacks that it can take advantage of.&amp;nbsp; One to indicate that registration was successful (we also get the Device <span class="caps">ID</span> from here), one to indicate that something went wrong (e.g. if we are running in the simulator, which doesn’t support push notifications), and one for when we actually receive a&nbsp;message).</p>
<p>The first two are easy to handle:
&lt;pre class=&quot;brush:c&quot;&gt;- (void)application:(UIApplication <em>)app didRegisterForRemoteNotificationsWithDeviceToken:(NSData </em>)deviceToken&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp; NSString *str = [NSString stringWithFormat:@&quot;Device&nbsp;Token=%@&quot;,deviceToken];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;NSLog(@&quot;%@&quot;,str);</p>
<p>}</p>
<ul>
<li>(void)application:(UIApplication <em>)app didFailToRegisterForRemoteNotificationsWithError:(NSError </em>)err&nbsp;{</li>
</ul>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp; NSString *str = [NSString stringWithFormat: @&quot;Error: %@&quot;,&nbsp;err];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; NSLog(@&quot;%@&quot;,str);&amp;nbsp;&amp;nbsp;&amp;nbsp; 
}&nbsp;&lt;&#x2F;pre&gt;</p>
<p>Note how the first method (didRegisterForRemoteNotificationsWithDeviceToken) is where we actually extract the DEVICE_TOKEN string required in the worker role.&amp;nbsp; You’ll have to run this once, and copy and paste appropriately.&amp;nbsp; Of course, in a production environment, we would likely pass this value to the service via a separate&nbsp;call.&amp;nbsp; </p>
<p>The third callback gets called when the device actually receives a message.
&lt;pre class=&quot;brush:c&quot;&gt;- (void)application:(UIApplication <em>)application didReceiveRemoteNotification:(NSDictionary </em>)userInfo&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp; for (id key in userInfo)&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSLog(@&quot;key: %@, value: %@&quot;, key, [userInfo&nbsp;objectForKey:key]);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSString *payload = [NSString stringWithFormat:@&quot;%@&quot;,[userInfo&nbsp;objectForKey:key]];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &#x2F;&#x2F; work out the session code from the <span class="caps">JSON</span>&nbsp;payload</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSRegularExpression*&nbsp;regex;</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSTextCheckingResult*&nbsp;result;</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSError* error =&nbsp;nil;</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSString<em> regexStr = @&quot;session = ([^&#39;]</em>);&quot;;</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSString* value =&nbsp;nil;</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; regex = [NSRegularExpression regularExpressionWithPattern:regexStr options:NSRegularExpressionCaseInsensitive&nbsp;error:&amp;amp;error];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; result = [regex firstMatchInString:payload options:0 range:NSMakeRange(0,&nbsp;payload.length)];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if(result &amp;amp;&amp;amp; [result numberOfRanges] ==&nbsp;2)</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSRange r = [result&nbsp;rangeAtIndex:1];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; value = [payload&nbsp;substringWithRange:r];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if(value)</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSLog(@&quot;Found session value in payload:&nbsp;%@&quot;,value);</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; NSString* jsString = <a href="http:&#x2F;&#x2F;URLHERE.cloudapp.net&#x2F;Session&#x2F;Lookup?session=%@&amp;quot;">NSString stringWithFormat:@&quot;handleOpenURL(&quot;[http:&#x2F;&#x2F;<span class="caps">URLHERE</span>.cloudapp.net&#x2F;Session&#x2F;Lookup?session=%@&quot;);&quot;,value];</a>;&amp;quot;,value];)</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [webView&nbsp;stringByEvaluatingJavaScriptFromString:jsString];</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}</p>
<p>&amp;nbsp;&amp;nbsp;&amp;nbsp; }&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}</p>
<p>&amp;nbsp;&nbsp;&lt;&#x2F;pre&gt;</p>
<p>As you can see above, this method parses the payload of the message, tries to work out the session code, and if one is found, creates a new javascript call to a method called handleOpenURL which instructs PhoneGap to call the method of the same name.&amp;nbsp; Of course, you are going to want to configure this for your own scenario, but hopefully this gives you a sense of how to pass a value as part of the message, and then take an action on that&nbsp;accordingly.&amp;nbsp; </p>
<p>Well, that wraps up this post.&amp;nbsp; I hope you enjoyed the talk at <span class="caps">MIX</span>, and that this code is useful if you have services in Windows Azure that have a need to push notification messages to iPhone and iPad&nbsp;devices. </p>
<p>&lt;pre&gt;&lt;&#x2F;pre&gt;</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2014 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>