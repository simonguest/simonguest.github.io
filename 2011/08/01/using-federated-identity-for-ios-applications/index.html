<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Using Federated Identity for iOS Applications - simonguest.com
    </title>
    <link rel="alternate" href="feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Using Federated Identity for iOS Applications</h1>
        <p class="author">Written by <span class="author">Simon Guest</span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>Last week, Microsoft released v1.2 of the Windows Azure Toolkit for iOS.  As development partner for the toolkit, <a href="http://www.neudesic.com">Neudesic</a> has been working with several customers on implementing <span class="caps">ACS</span> for iPhone and iPad applications.  Due to popular demand, I wanted to share a short overview of how simple it is to get this up and working for your own iOS&nbsp;projects.</p>
<p><span class="more"></span></p>
<p><strong>First, some&nbsp;background…</strong></p>
<p>Many iPhone and iPad applications have a need to authenticate.  Maybe it’s to access sensitive information or record a particular high score against your name.  Implementing an authentication scheme for iOS can however be time consuming and tricky – you often have to create an authentication service, host it, expose the service through <span class="caps">REST</span>, and consume it on the device.  And afterwards you are responsible for backing up the user database and dealing with lost passwords,&nbsp;etc.</p>
<p>To help overcome this many applications are now turning to external providers.  For example, to identify yourself when playing Zynga Poker, instead of creating a new account, you simply sign into Facebook (when launching the application for the first time) and the game uses these credentials as you play. This type of sign in method is called federated identity. This prevents Zynga from having to maintain a complex and large set of user accounts and passwords, and also prevents the player from having to remember yet another username and&nbsp;password. </p>
<p>Adding federated identity to your iPhone or iPad application can be difficult, requiring knowledge of exchange secure tokens with a set of providers, and creating and sending the right OAuth headers in your application.  Removing this difficultly is exactly what we are trying to address in v1.2 of the Windows Azure Toolkit for&nbsp;iOS. </p>
<p><strong>Sounds great – how do I use&nbsp;it?</strong></p>
<p>To implement <span class="caps">ACS</span> in your application, you’ll first need to access the Windows Azure portal by navigating to <a href="http://windows.azure.com/">http://windows.azure.com</a> and signing in with your&nbsp;credentials.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image002.png" alt="clip_image002"></p>
<p>Click on the <strong>Service Bus, Access Control <span class="amp">&amp;</span> </strong>Caching menu item and select the <strong>Access Control</strong> menu item under the <strong>AppFabric</strong> folder.  Select an active Windows Azure subscription and click on the <strong>New</strong> button in the&nbsp;toolbar.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image004.png" alt="clip_image004"></p>
<p>The new service namespace dialog will open.  Ensure that <strong>Access Control</strong> is selected, and enter a unique namespace and country/region for the&nbsp;service.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image006.png" alt="clip_image006"></p>
<p>The <span class="caps">ACS</span> namespace will now be created.  This might take a few minutes.  Wait until the namespace is showing in an <strong>Active</strong>&nbsp;state.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image008.png" alt="clip_image008"></p>
<p>Once this is complete, highlight the newly created service and click on the <strong>Access Control Service</strong> button in the toolbar.  This will launch the Access Control Service&nbsp;portal.</p>
<p>Within the portal, click on <strong>Identity Providers</strong> and add the identity providers you would like to use for your&nbsp;application.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image010.png" alt="clip_image010"></p>
<p>The default is Windows Live <span class="caps">ID</span>, but you can add other preconfigured providers (such as Google and Yahoo!) as well as external identity systems configured to use&nbsp;WS-Federation.</p>
<p>Once you have added the required providers, click on the <strong>Relying Parties</strong> section of the&nbsp;portal.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image012.png" alt="clip_image012"></p>
<p>Click on the <strong>Add</strong> button and enter the following information for the relying party&nbsp;application:</p>
<p><strong>Name</strong> – a given name for your&nbsp;application</p>
<p><strong>Realm</strong> – a unique <span class="caps">ID</span> for your application.  For this walkthrough, we’ll be using&nbsp;uri:wazmobiletoolkit</p>
<p><strong>Return <span class="caps">URL</span></strong> – you can leave this&nbsp;blank</p>
<p><strong>Error <span class="caps">URL</span></strong> – you can leave this&nbsp;blank</p>
<p><strong>Token Format</strong> – select&nbsp;<span class="caps">SWT</span></p>
<p><strong>Token Lifetime</strong> – Feel free to change the default from 600&nbsp;seconds.</p>
<p>Select the identity providers that you would like to use, and then under the <strong>Token Signing Settings</strong> section, click on the <strong>Generate</strong> button to create a new symmetric key that will be used for this&nbsp;application.</p>
<p>Finally, click on the <strong>Save</strong> button.  This will create the Relying Party&nbsp;Application.</p>
<p>Next, go into the <strong>Rule Groups</strong> section of the portal and select the default rule group that was created for the&nbsp;application.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image014.png" alt="clip_image014"></p>
<p>Click on the <strong>Generate</strong> link in order to generate a set of default rules for this rule&nbsp;group.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image016.png" alt="clip_image016"></p>
<p>Select the providers that you wish to use, and click on the <strong>Generate</strong> button.  Once this is complete, you should see a set of&nbsp;rules.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image018.png" alt="clip_image018"></p>
<p>After this step is complete, <span class="caps">ACS</span> has now been configured correctly to be used with your iOS application.  Make a note of your Service Namespace (found at the top of the portal) and&nbsp;Realm.</p>
<p><strong>Ok, the service is now setup.  How do I use it in my Xcode&nbsp;project?</strong></p>
<p>To start, launch Xcode (4.02 or higher) and create a new&nbsp;project.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image020.png" alt="clip_image020"></p>
<p>From the project template dialog, select a <strong>View-based application</strong> and click on the <strong>Next</strong> button.  Enter a <strong>Product Name</strong> and <strong>Company Identifier</strong> and click on the <strong>Next</strong> button to continue.  Select a directory to use for the project file and return to the&nbsp;<span class="caps">IDE</span>.</p>
<p>Next, download the latest version of the Windows Azure Toolkit for iOS library from <a href="http://github.com/microsoft-dpe/watoolkitios-lib">http://github.com/microsoft-dpe/watoolkitios-lib</a>. In the download will be a zip file containing two versions of the library (one for the device, one for the simulator) and some header files for the&nbsp;project.</p>
<p>Right click on your project and select the <strong>Add Files to…</strong> menu&nbsp;option.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image022.png" alt="clip_image022"></p>
<p>Locate the .a file (for the simulator) and header files and add them to your project.  You may want to create a new group (called lib) to store these&nbsp;in.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image024.png" alt="clip_image024"></p>
<p>Now we need to add a reference to a library required for <span class="caps">XML</span> parsing.  To do this, click on the top most project file, click on the target in the 2<span class="ord">nd</span> column of the IDE, and select <strong>Build Phases</strong> from the tab&nbsp;menu.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image026.png" alt="clip_image026"></p>
<p>In the main window, expand the <strong>Link Binary with Libraries</strong>&nbsp;option.</p>
<p>Ensure that the libwatoolkitios.a file has been automatically added as a reference, click the + button to add a new library, and select the libxml2.dylib library from the drop down&nbsp;list.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image028.png" alt="clip_image028"></p>
<p>Click on the <strong>Add</strong> button to add a reference to this library for your&nbsp;project.</p>
<p>Before we start adding any code, we need to add a couple of required linker flags to the project.  To do this, click on the <strong>Build Settings</strong> tab (next to Build&nbsp;Phases).</p>
<p>In the search box, type “other linker” to filter the&nbsp;settings.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image030.png" alt="clip_image030"></p>
<p>You should see a setting called <strong>Other Linker Flags</strong>.  Double click on the right side of this row to add new&nbsp;flags.</p>
<p>Click on the + button to add two flags.  The first is <strong>–ObjC</strong> and the second is <strong>–all_load</strong>.  Once complete, your linker flags should look like the following&nbsp;screenshot:</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image032.png" alt="clip_image032"></p>
<p>Click on the <strong>Done</strong> button to save these settings.  The project is now configured correctly to reference the Windows Azure Toolkit&nbsp;library.</p>
<p>To test that the library works, click on the project’s <strong>[ProjectName]AppDelegate.m</strong> file.  Add the following #import statement at the top of the&nbsp;class:</p>
<pre><code class="lang-objectivec"><span class="preprocessor">#import <span class="title">"WACloudAccessControlClient.h"</span></span>
</code></pre>
<p>Next, search for a method called <strong>didFinishLaunchingWithOptions </strong>and after the <strong>[self.window makeKeyAndVisible]</strong> line, enter the following&nbsp;code.</p>
<pre><code class="lang-objectivec"><span class="built_in">NSLog</span>(@<span class="string">"Intializing the Access Control Client..."</span>);
WACloudAccessControlClient *acsClient = [WACloudAccessControlClient accessControlClientForNamespace:@<span class="string">"iostest-walkthrough"</span> realm:@<span class="string">"uri:wazmobiletoolkit"</span>];
[acsClient showInViewController:<span class="keyword">self</span><span class="variable">.viewController</span> allowsClose:<span class="literal"><span class="caps">NO</span></span> withCompletionHandler:^(<span class="built_in"><span class="caps">BOOL</span></span> authenticated) {
    <span class="keyword">if</span> (!authenticated)
    {
        <span class="built_in">NSLog</span>(@<span class="string">"Error authenticating"</span>);
    }
    <span class="keyword">else</span>
    {
        <span class="built_in">NSLog</span>(@<span class="string">"Creating the authentication token..."</span>);
        WACloudAccessToken *token = [WACloudAccessControlClient sharedToken];
        <span class="comment">/* Do something with the token here! */</span>
    }
}];
</code></pre>
<p>Replace the namespace and realm in the first line with the service namespace and realm for your own&nbsp;service.</p>
<p>As you can see from the above, the code creates a new instance of the access control client, requests that the client shows itself in the current view controller, and then extracts a&nbsp;token.</p>
<p>Build and run the application in the iOS&nbsp;Simulator.</p>
<p>Once the application starts, you should be prompted to select an identity provider from the list that you configured in your <span class="caps">ACS</span>&nbsp;service.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image034.png" alt="clip_image034"></p>
<p>Pick one of the providers, and enter a valid set of&nbsp;credentials.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image036.png" alt="clip_image036"></p>
<p>Click on the <strong>Remember me</strong> checkbox if you want to skip this step when running this application again, and click on the <strong>Sign in</strong>&nbsp;button.</p>
<p>The first time the application is run, you’ll be prompted to authorize the application to access your provider&nbsp;data.</p>
<p><img src="/articles/using-federated-identity-for-ios-applications/clip_image038.png" alt="clip_image038"></p>
<p>Click on the <strong>Allow</strong> button to continue.  The login window will now disappear and you’ll be returned to your&nbsp;application.</p>
<p>In the debug window, you should see the following two&nbsp;logs:</p>
<pre><code>2011-07-22 10:12:26.284 iostest-walkthrough[25838:207] Intializing the Access Control Client...
2011-07-22 10:12:36.359 iostest-walkthrough[25838:207] Creating the authentication token...
</code></pre><p>If you are seeing this, congratulations!  You’ve successfully setup federated identity for your application.  The final message indicates that the access token was retrieved and can be used for further use.  The <strong>WACloudAccessToken</strong> (derived from <strong>[WACloudAccessControlClient sharedToken]</strong>) contains an NSDictionary of claims and other properties that can be stored within your application.  Using these properties on future calls can be used to identify returning users to your&nbsp;application.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2015 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
            <script type="text/javascript">
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-56671816-1', 'auto');
              ga('send', 'pageview');
              
            </script>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>