<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Authenticating with Google, Facebook, and others from your jQueryMobile Application - simonguest.com
    </title>
    <link rel="alternate" href="//feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Authenticating with Google, Facebook, and others from your jQueryMobile Application</h1>
        <p class="author">Written by <span class="author">Simon Guest</span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>In my last post, I showed how to implement authentication using Google, Facebook, etc. for your iOS application – using the <a href="http://github.com/microsoft-dpe">Windows Azure Toolkit for iOS</a>.  This works well for iPhone applications written in Objective C, but what if you are developing a Web based mobile applications that span multiple platforms?  Given that everything is using Web pages, you would hope that it would be a little easier, but things can get tricky - especially if you are using&nbsp;jQueryMobile. </p>
<p><span class="more"></span></p>
<p>Having implemented this a couple of times now, here is a rough guide of how to integrate AppFabric <span class="caps">ACS</span> (Access Control Service) authentication into a jQueryMobile application. (There is already a ton of documentation of both jQueryMobile and ACS, so I’m assuming that you understand the basics of how these both&nbsp;work).   </p>
<p><strong>Step 1:  Create your own provider selection&nbsp;screen</strong></p>
<p>When you first start playing around with using <span class="caps">ACS</span> on mobile web browsers, the first thing you’ll notice is that the default login page isn’t that&nbsp;nice. </p>
<p><img src="/articles/authenticating-with-google-facebook-and-others-from-your-jquerymobile-application/defaultlogin.png" alt="Default Login"></p>
<p>While the functionality of logging in will work, users have to pinch zoom to be able to read the buttons, which isn’t a great experience.  It also doesn’t fit in with any jQueryMobile theme that you may have created.  To overcome this, we can create our own provider&nbsp;screen. </p>
<p><img src="/articles/authenticating-with-google-facebook-and-others-from-your-jquerymobile-application/jquerylogin.png" alt="jQuery Login"></p>
<p>To build something similar to the above, I’ve used a jQueryMobile <a href="http://jquerymobile.com/test/docs/pages/dialog-alt.html">Dialog</a> (which has an automatic border as well as a background effect).  The basic code for the screen looks like the&nbsp;following:</p>
<pre><code class="lang-html"><span class="doctype">&lt;!<span class="caps">DOCTYPE</span> html&gt;</span>
<span class="tag">&lt;<span class="title">html</span>&gt;</span>
<span class="tag">&lt;<span class="title">head</span>&gt;</span>
    <span class="tag">&lt;<span class="title">title</span>&gt;</span>Select Login Provider<span class="tag">&lt;/<span class="title">title</span>&gt;</span>
<span class="tag">&lt;/<span class="title">head</span>&gt;</span>
<span class="tag">&lt;<span class="title">body</span>&gt;</span>
    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">data-role</span>=<span class="value">"dialog"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">data-role</span>=<span class="value">"header"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Select Login Provider<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">data-role</span>=<span class="value">"content"</span>&gt;</span>
            @{
                if (ViewBag.JSONProviders != null)
                    {
                    var providers = Json.Decode(ViewBag.JSONProviders);
                    foreach (var provider in providers)
                    {
                        <span class="tag">&lt;<span class="title">button</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">onclick</span>=<span class="value">"javascript:window.location.href='@provider.LoginUrl'"</span>&gt;</span>@provider.Name<span class="tag">&lt;/<span class="title">button</span>&gt;</span>
                    }
                }
            }
        <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span>
</code></pre>
<p>As you can see from the above, the form is built by parsing a <span class="caps">JSON</span> object containing a list of identity providers and creating buttons for each provider – setting a name for a button and setting an on click action to the URL.  (The above code uses the Razor-based syntax for  ASP.NET MVC, but the same will work just by using JSON calls in regular&nbsp;Javascript). </p>
<p>Two things to note&nbsp;here:</p>
<ol>
<li><p>It’s really important to use <strong>window.location.href</strong> instead of an anchor when linking to the provider – otherwise you’ll break the <span class="caps">AJAX</span> model of your jQueryMobile app and a new browser window will be launched (which looks horrible, especially in full screen web&nbsp;applications).</p>
</li>
<li><p>You are probably asking yourself where the <span class="caps">JSON</span> objects actually come from.  This brings us to our next&nbsp;point…</p>
</li>
</ol>
<p><strong>Step 2:  Make a call to the <span class="caps">ACS</span> JSON&nbsp;endpoint</strong></p>
<p>The buttons in the form are based on identity providers, which you likely setup when you configured <span class="caps">ACS</span>.  These providers can be extracted as JSON objects using a JSON based endpoint that the ACS service&nbsp;providers. </p>
<p>Here’s the <span class="caps">URL</span> of the JSON endpoint for ACS&nbsp;v2.</p>
<pre><code>https://{0}.accesscontrol.windows.net/v2/metadata/IdentityProviders.js?protocol=wsfederation&amp;realm={1}&amp;reply_to={2}&amp;context=&amp;request_id=&amp;version=1.0](https://{0}.accesscontrol.windows.net/v2/metadata/IdentityProviders.js?protocol=wsfederation&amp;realm={1}&amp;reply_to={2}&amp;context=&amp;request_id=&amp;version=1.0)
</code></pre><p>{0} is the namespace of your <span class="caps">ACS</span>&nbsp;service</p>
<p>{1} is the realm within your <span class="caps">ACS</span>&nbsp;service</p>
<p>{2} is an optional <span class="caps">URL</span> (which must be HTML encoded) that specifies where to return the browser once authentication has been completed.  Remember, if you are using AJAX navigation, then you’ll want to pass in the correct #-prefixed syntax.  For example a return URL of the&nbsp;following:</p>
<pre><code>http://localhost/MyWebApp#/MyWebApp/Accounts
</code></pre><p>Will instruct the <span class="caps">ACS</span> service to return to the Accounts page in your jQueryMobile&nbsp;app.</p>
<p>Again, you can make the call to the <span class="caps">JSON</span> endpoint using Javascript, or if you are using ASP.NET MVC like in Step 1 I would recommend creating a controller action called Providers which passes the return JSON object in a&nbsp;ViewBag. </p>
<p><strong>Step 3:  Launch the providers screen from your&nbsp;app</strong></p>
<p>Finally, once you have your provider screen created, you’ll need to call it when authentication is required.  There are a couple of different ways of doing this – if you are using Javascript only, then create and maintain a variable called claims – which corresponds to the claims bag returned from the service (when the <span class="caps">ACS</span> service returns it does a post back to your application so that you can capture the claims).  Secondly, if you are using ASP.NET MVC then you can create a second action on the Account controller called claims with something similar to the&nbsp;following:</p>
<pre><code class="lang-csharp">public JsonResult Claims()
{
    return Json(string.Join(&quot;n&quot;, ((IClaimsIdentity)this.User.Identity).Claims.Select(c =&gt; c.ClaimType + &quot;: &quot; + c.Value).ToArray()));
}
</code></pre>
<p>This will return the claims bag directly from the User.Identity property from the&nbsp;controller.</p>
<p>Well, just a short overview, but if you are thinking of implementing Google and Facebook authentication in your jQueryMobile application, hopefully this has been of some&nbsp;help.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2014 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
            <script type="text/javascript">
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-56671816-1', 'auto');
              ga('send', 'pageview');
              
            </script>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>