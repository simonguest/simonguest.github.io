<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Extracting and Using Facebook OAuth Token from ACS - simonguest.com
    </title>
    <link rel="alternate" href="//feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Extracting and Using Facebook OAuth Token from ACS</h1>
        <p class="author">Written by <span class="author">Simon Guest</span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>A couple of my previous blog posts have shown how AppFabric <span class="caps">ACS</span> (Access Control Service) can be used as part of the Windows Azure Toolkit for iOS to enable federated authentication with Facebook, Google, Yahoo, and other providers. I was recently asked whether it’s possible to extract an OAuth token as part of the ACS sign in process that can then be presented to Facebook’s Graph API in order to access details such as friends lists, photos, etc. In this post, I’ll cover how this can be&nbsp;done.</p>
<p><span class="more"></span></p>
<p>The first step is of course to display the authentication page. As you’ve seen in previous posts, this can be achieved using the&nbsp;following:</p>
<pre><code class="lang-objectivec">WACloudAccessControlClient *acsClient = [WACloudAccessControlClient accessControlClientForNamespace:@“iostest-walkthrough” realm:@“uri:wazmobiletoolkit”];
[acsClient showInViewController:<span class="keyword">self</span> allowsClose:<span class="literal"><span class="caps">NO</span></span> withCompletionHandler:^(<span class="built_in"><span class="caps">BOOL</span></span> authenticated) { <span class="keyword">if</span> (!authenticated) { <span class="built_in">NSLog</span>(@<span class="string">"Error authenticating"</span>); } <span class="keyword">else</span> { WACloudAccessToken *token = [WACloudAccessControlClient sharedToken]; <span class="built_in">NSString</span> *securityToken = [token securityToken]; ... }
}];
</code></pre>
<p>In the application, this will display the federated login dialog, and prompt the user to enter their Facebook&nbsp;credentials.</p>
<p><img src="/articles/extracting-and-using-facebook-oauth-token-from-acs/facebooklogin.jpg" alt="Facebook Login"></p>
<p>You’ll notice that the <span class="caps">ACS</span> client returns a cloud access token, of which a security token can be extracted. This security token is a set of claims returned from ACS. Here’s an&nbsp;example:</p>
<pre><code>http://schemas.microsoft.com/ws/2008/06/identity/claims/expiration=2011-11-11T22:00:00.3593475Z&amp;amp;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress=me%40simonguest.com&amp;amp;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name=Simon+Guest&amp;amp;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier=677830765&amp;amp;http://www.facebook.com/claims/AccessToken=AAADWLwgHWSUBABBXdxbhJB0ZBtA3VOfPSsqzKKwObAtW2rb8EGGTQ8EvnvAdNOcZAGpKfV2gSGbNg7f0gxk4BhI1rhzKEn17VLw343gZDZD&amp;amp;http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider=Facebook-235497486506277&amp;amp;Audience=uri:wazmobiletoolkit&amp;amp;ExpiresOn=1321044986&amp;amp;Issuer=https://iostest-walkthrough.accesscontrol.windows.net/&amp;amp;HMACSHA256=bnvyPmX4/PcWhiImgVVIvSqwHpc4cfi0vI6%2b/BSDK0Q%3d
</code></pre><p>If we want to make follow on calls to Facebook’s Graph <span class="caps">API</span>, we are going to need to present the Facebook User ID and an OAuth Token. Fortunately both of these can be extracted from the&nbsp;token.</p>
<p>To extract this, we first <span class="caps">HTTP</span> encode the&nbsp;token:</p>
<pre><code class="lang-objectivec"><span class="built_in">NSMutableArray</span> *httpEncoding = [<span class="built_in">NSMutableArray</span> arrayWithObjects:[<span class="built_in">NSArray</span> arrayWithObjects:@<span class="string">"%3a"</span>,@<span class="string">":"</span>,<span class="literal">nil</span>], [<span class="built_in">NSArray</span> arrayWithObjects:@<span class="string">"%2f"</span>,@<span class="string">"/"</span>,<span class="literal">nil</span>], <span class="literal">nil</span>];
<span class="keyword">while</span> ([httpEncoding count] &amp;gt;= <span class="number">1</span>) { securityToken = [securityToken stringByReplacingOccurrencesOfString:[[httpEncoding objectAtIndex:<span class="number">0</span>] objectAtIndex:<span class="number">0</span>] withString:[[httpEncoding objectAtIndex:<span class="number">0</span>] objectAtIndex:<span class="number">1</span>]]; [httpEncoding removeObjectAtIndex:<span class="number">0</span>]; }
<span class="built_in">NSError</span> *error = <span class="literal"><span class="caps">NULL</span></span>;
</code></pre>
<p>Using a simple RegEx search we can extract the Facebook User&nbsp;<span class="caps">ID</span>:</p>
<pre><code class="lang-objectivec">NSRegularExpression regex = [NSRegularExpression regularExpressionWithPattern:@“http:<span class="comment">//schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier=([0-9])” options:0 error:&amp;amp;error];</span>
NSTextCheckingResult *match = [regex firstMatchInString:securityToken options:<span class="number">0</span> range:NSMakeRange(<span class="number">0</span>, [securityToken length])]; firstRange = [match rangeAtIndex:<span class="number">1</span>]; fbuserId = [securityToken substringWithRange:firstRange];
</code></pre>
<p>And the required&nbsp;OAuthToken:</p>
<pre><code class="lang-objectivec">regex = [NSRegularExpression regularExpressionWithPattern:@“http:<span class="comment">//www.facebook.com/claims/AccessToken=([A-Za-z0-9]*)” options:0 error:&amp;amp;error];</span>
match = [regex firstMatchInString:securityToken options:<span class="number">0</span> range:NSMakeRange(<span class="number">0</span>, [securityToken length])];
<span class="built_in">NSRange</span> firstRange = [match rangeAtIndex:<span class="number">1</span>];
oauthToken = [securityToken substringWithRange:firstRange];
</code></pre>
<p>Now it’s just a case of calling the Graph <span class="caps">API</span> using these&nbsp;credentials:</p>
<pre><code class="lang-objectivec"><span class="built_in">NSString</span> *graphURL = [<span class="built_in">NSString</span> stringWithFormat:@“https:<span class="comment">//graph.facebook.com/%@/friends?access_token=%@”,fbuserId,oauthToken];</span>
</code></pre>
<p>For the purposes of this post, let’s take a quick look at my list of&nbsp;friends.</p>
<pre><code class="lang-objectivec"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in"><span class="caps">NSURL</span></span> URLWithString:graphURL]];
NSURLResponse *response = <span class="literal"><span class="caps">NULL</span></span>;
NSData *data = [<span class="built_in">NSURLConnection</span> sendSynchronousRequest:request returningResponse:&amp;amp;response error:&amp;amp;error];
<span class="built_in">NSString</span> *friendsList = [[<span class="built_in">NSString</span> alloc] initWithData:data encoding:NSUTF8StringEncoding];
regex = [NSRegularExpression regularExpressionWithPattern:@“<span class="keyword">id</span>” options:<span class="number">0</span> error:&amp;amp;error];
NSUInteger friendCount = [regex numberOfMatchesInString:friendsList options:<span class="number">0</span> range:NSMakeRange(<span class="number">0</span>, [friendsList length])];
</code></pre>
<p>Displaying the friend count in a UIAlertView on the screen shows how popular (or not!) I&nbsp;am:</p>
<p><img src="/articles/extracting-and-using-facebook-oauth-token-from-acs/facebookmessage.jpg" alt="Facebook Message"></p>
<p>A simple example, but hopefully this shows not only that you can authenticate against Facebook using AppFabric <span class="caps">ACS</span>, but also how the returned Facebook User ID and OAuth Token can be used to make further calls to Facebook using the user’s&nbsp;credentials.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2015 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
            <script type="text/javascript">
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-56671816-1', 'auto');
              ga('send', 'pageview');
              
            </script>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>