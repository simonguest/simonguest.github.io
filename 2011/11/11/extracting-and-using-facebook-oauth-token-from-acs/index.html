<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Extracting and Using Facebook OAuth Token from ACS - simonguest.com
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Extracting and Using Facebook OAuth Token from ACS</h1>
        <p class="author">Written by <span class="author"></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>A couple of my previous blog posts have shown how AppFabric <span class="caps">ACS</span> (Access Control Service) can be used as part of the Windows Azure Toolkit for iOS to enable federated authentication with Facebook, Google, Yahoo, and other&nbsp;providers.</p>
<p>I was recently asked whether it’s possible to extract an OAuth token as part of the <span class="caps">ACS</span> sign in process that can then be presented to Facebook’s Graph API in order to access details such as friends lists, photos, etc. In this post, I&#39;ll cover how this can be&nbsp;done.</p>
<p>The first step is of course to display the authentication page. As you&#39;ve seen in previous posts, this can be achieved using the following:
&lt;pre&gt;WACloudAccessControlClient *acsClient = [WACloudAccessControlClient accessControlClientForNamespace:@“iostest-walkthrough”&nbsp;realm:@“uri:wazmobiletoolkit”];</p>
<p>[acsClient showInViewController:self allowsClose:<span class="caps">NO</span> withCompletionHandler:^(BOOL authenticated) { if (!authenticated) { NSLog(@&quot;Error authenticating&quot;); } else { WACloudAccessToken <em>token = [WACloudAccessControlClient sharedToken]; NSString </em>securityToken = [token securityToken]; … }
}];&lt;&#x2F;pre&gt;
In the application, this will display the federated login dialog, and prompt the user to enter their Facebook&nbsp;credentials.</p>
<p><img src="http:&#x2F;&#x2F;simonguest.com&#x2F;wp-content&#x2F;uploads&#x2F;2011&#x2F;11&#x2F;myWPEdit_Image_1321045984.jpg" alt="myWPEdit Image"></p>
<p>You&#39;ll notice that the <span class="caps">ACS</span> client returns a cloud access token, of which a security token can be extracted. This security token is a set of claims returned from ACS. Here’s an example:
&lt;pre&gt;http:&#x2F;&#x2F;schemas.microsoft.com&#x2F;ws&#x2F;2008&#x2F;06&#x2F;identity&#x2F;claims&#x2F;expiration=2011-11-11T22:00:00.3593475Z&amp;amp;http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;ws&#x2F;2005&#x2F;05&#x2F;identity&#x2F;claims&#x2F;emailaddress=me%40simonguest.com&amp;amp;http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;ws&#x2F;2005&#x2F;05&#x2F;identity&#x2F;claims&#x2F;name=Simon+Guest&amp;amp;http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;ws&#x2F;2005&#x2F;05&#x2F;identity&#x2F;claims&#x2F;nameidentifier=677830765&amp;amp;http:&#x2F;&#x2F;www.facebook.com&#x2F;claims&#x2F;AccessToken=AAADWLwgHWSUBABBXdxbhJB0ZBtA3VOfPSsqzKKwObAtW2rb8EGGTQ8EvnvAdNOcZAGpKfV2gSGbNg7f0gxk4BhI1rhzKEn17VLw343gZDZD&amp;amp;http:&#x2F;&#x2F;schemas.microsoft.com&#x2F;accesscontrolservice&#x2F;2010&#x2F;07&#x2F;claims&#x2F;identityprovider=Facebook-235497486506277&amp;amp;Audience=uri:wazmobiletoolkit&amp;amp;ExpiresOn=1321044986&amp;amp;Issuer=https:&#x2F;&#x2F;iostest-walkthrough.accesscontrol.windows.net&#x2F;&amp;amp;HMACSHA256=bnvyPmX4&#x2F;PcWhiImgVVIvSqwHpc4cfi0vI6%2b&#x2F;BSDK0Q%3d&lt;&#x2F;pre&gt;
If we want to make follow on calls to Facebook’s Graph API, we are going to need to present the Facebook User ID and an OAuth Token. Fortunately both of these can be extracted from the&nbsp;token.</p>
<p>To extract this, we first <span class="caps">HTTP</span> encode the token:
&lt;pre&gt;NSMutableArray *httpEncoding = [NSMutableArray arrayWithObjects:[NSArray arrayWithObjects:@&quot;%3a&quot;,@&quot;:&quot;,nil], [NSArray arrayWithObjects:@&quot;%2f&quot;,@&quot;&#x2F;&quot;,nil],&nbsp;nil];</p>
<p>while ([httpEncoding count] &amp;gt;= 1) { securityToken = [securityToken stringByReplacingOccurrencesOfString:[[httpEncoding objectAtIndex:0] objectAtIndex:0] withString:[[httpEncoding objectAtIndex:0] objectAtIndex:1]]; [httpEncoding removeObjectAtIndex:0];&nbsp;}</p>
<p>NSError <em>error = <span class="caps">NULL</span>;&lt;&#x2F;pre&gt;
Using a simple RegEx search we can extract the Facebook User ID:
&lt;pre&gt;NSRegularExpression regex = [NSRegularExpression regularExpressionWithPattern:@“http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;ws&#x2F;2005&#x2F;05&#x2F;identity&#x2F;claims&#x2F;nameidentifier=([0-9])” options:0 error:&amp;amp;error];
NSTextCheckingResult </em>match = [regex firstMatchInString:securityToken options:0 range:NSMakeRange(0, [securityToken length])]; firstRange = [match rangeAtIndex:1]; fbuserId = [securityToken substringWithRange:firstRange];&lt;&#x2F;pre&gt;
And the required OAuthToken:
&lt;pre&gt;regex = [NSRegularExpression regularExpressionWithPattern:@“http:&#x2F;&#x2F;www.facebook.com&#x2F;claims&#x2F;AccessToken=([A-Za-z0-9]*)” options:0&nbsp;error:&amp;amp;error];</p>
<p>match = [regex firstMatchInString:securityToken options:0 range:NSMakeRange(0, [securityToken length])];
NSRange firstRange = [match rangeAtIndex:1];
oauthToken = [securityToken substringWithRange:firstRange];
&lt;&#x2F;pre&gt;
Now it’s just a case of calling the Graph <span class="caps">API</span> using these credentials:
&lt;pre&gt;NSString <em>graphURL = [NSString stringWithFormat:@“https:&#x2F;&#x2F;graph.facebook.com&#x2F;%@&#x2F;friends?access_token=%@”,fbuserId,oauthToken];&lt;&#x2F;pre&gt;
For the purposes of this post, let’s take a quick look at my list of friends.
&lt;pre&gt;NSURLRequest </em>request = [NSURLRequest requestWithURL:[<span class="caps">NSURL</span> URLWithString:graphURL]];
NSURLResponse <em>response = <span class="caps">NULL</span>;
NSData </em>data = [NSURLConnection sendSynchronousRequest:request returningResponse:&amp;amp;response error:&amp;amp;error];
NSString *friendsList = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
regex = [NSRegularExpression regularExpressionWithPattern:@“id” options:0 error:&amp;amp;error];
NSUInteger friendCount = [regex numberOfMatchesInString:friendsList options:0 range:NSMakeRange(0, [friendsList length])];&lt;&#x2F;pre&gt;
Displaying the friend count in a UIAlertView on the screen shows how popular (or not!) I&nbsp;am:</p>
<p><img src="http:&#x2F;&#x2F;simonguest.com&#x2F;wp-content&#x2F;uploads&#x2F;2011&#x2F;11&#x2F;myWPEdit_Image_1321046009.jpg" alt="myWPEdit Image"></p>
<p>A simple example, but hopefully this shows not only that you can authenticate against Facebook using AppFabric <span class="caps">ACS</span>, but also how the returned Facebook User ID and OAuth Token can be used to make further calls to Facebook using the user’s&nbsp;credentials.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2014 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>