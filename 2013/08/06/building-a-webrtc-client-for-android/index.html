<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Building a WebRTC Client for Android - simonguest.com
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Building a WebRTC Client for Android</h1>
        <p class="author">Written by <span class="author"></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p><strong>*</strong> Update:  As a few readers have pointed out, the libjingle source has now been merged into the main WebRTC branch (https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;webrtc&#x2F;source&#x2F;browse&#x2F;trunk&#x2F;talk). As a result, some of the instructions here will need to be adjusted.  I&#39;m going to leave the post as is, but bear this in mind if you are following each of the steps.  Thanks.  <strong>*</strong></p>
<p>If you&#39;ve been following any of the recent developments with WebRTC, you&#39;ll know that the majority of samples and example code available today target the Web browser (typically Chrome or Firefox).  While this is useful to get up to speed, <span class="caps">IMO</span> one of the most powerful applications of WebRTC will be for mobile devices.  Despite this, getting WebRTC running on mobile can be somewhat&nbsp;challenging.</p>
<p>While Chrome Beta for Android supports WebRTC, any true mobile client will always need some kind of native application (in order to receive incoming calls in the background).  In this post, I&#39;ll be showing how to walk through the minefield of compiling WebRTC for Android in order to build your own demo app that you can expand&nbsp;upon.</p>
<p><img src="http:&#x2F;&#x2F;simonguest.com&#x2F;wp-content&#x2F;uploads&#x2F;2013&#x2F;08&#x2F;NewImage.png &quot;NewImage.png&quot;" alt="NewImage"></p>
<p><strong>Configuring your Build&nbsp;Environment</strong></p>
<p>In order to build Android WebRTC, you are going to need a machine running Linux.  For the purposes of this article, I would recommend some kind of virtual image (VMWare or VirtualBox) running Ubuntu Server 12.04.2 <span class="caps">LTS</span>.  When you build your VM image, ensure that you use the 64bit version of Ubuntu, and that you allocate a minimum of 2Gb RAM to the image (any less and you may well see the compiler running out of&nbsp;memory).</p>
<p>After you get your Linux <span class="caps">VM</span> up, the first thing is to install the required build tools.  First, the git and subversion&nbsp;clients:</p>
<p><code>sudo apt-get install git git-svn subversion</code></p>
<p>Then, you&#39;ll need the Chromium depot tools - these tools are required to build the WebRTC bits, much of which derives from various parts of the Chromium project.  To install:
<code>cd ~
git clone https:&amp;#x2F;&amp;#x2F;chromium.googlesource.com&amp;#x2F;chromium&amp;#x2F;tools&amp;#x2F;depot_tools.git</code></p>
<p>After the tools have been brought down, you&#39;ll also need to add them to your&nbsp;path:</p>
<p><code>echo export PATH=&amp;quot;$PATH&amp;quot;:</code>pwd<code>&amp;#x2F;depot_tools &amp;amp;gt;&amp;amp;gt; ~&amp;#x2F;.bashrc</code></p>
<p>Once this is done, log out and log back in to the server.  From the command line&nbsp;run:</p>
<p><code>gclient</code></p>
<p>If all is working, you should see a list of available client commands.  If you see &quot;command not found&quot;, edit the ~&#x2F;.bashrc file and double check your path is set&nbsp;correctly.</p>
<p>The final part of configuring your build environment involves installing some required libraries and compilers.  To perform this, use the following&nbsp;command:</p>
<p><code>sudo apt-get install g++ pkg-config gtk+-2.0 libnss3-dev</code></p>
<p>Once this is complete your machine should be in a position to start pulling down the WebRTC&nbsp;code.</p>
<p><strong>Obtaining libjingle Source&nbsp;Code</strong></p>
<p>In order to build the Android WebRTC client, we are going to pull down and compile the &quot;libjingle&quot; project.  Libjingle is a set of components to interoperate with Google Talk, but also contains (at the time of writing) the most complete and functional Android&nbsp;client.</p>
<p>To pull down the source, follow these instructions:
<code>cd ~
mkdir libjingle
cd libjingle
gclient config http:&amp;#x2F;&amp;#x2F;libjingle.googlecode.com&amp;#x2F;svn&amp;#x2F;trunk</code></p>
<p>After you&#39;ve run the config command you should notice a new file called .gclient in the ~&#x2F;libjingle directory.  Edit this file (using <span class="caps">VIM</span> or nano) and append the following to the end of the&nbsp;file:</p>
<p><code>target_os=[&amp;#39;android&amp;#39;,&amp;#39;unix&amp;#39;]</code></p>
<p>This will instruct gclient to pull down the required third party libraries and other tools for an Android build of&nbsp;libjingle.</p>
<p>With this file modified, run the following command from the ~&#x2F;linjingle&nbsp;directory:</p>
<p><code>gclient sync --nohooks</code></p>
<p>This will start a large sync of the liblibjingle source code, which will likely take some time.  A great opportunity for a coffee or break at this&nbsp;point!</p>
<p><strong>Installing the Oracle&nbsp;<span class="caps">JDK</span></strong></p>
<p>Before we can compile libjingle, we&#39;ll need to install the Oracle <span class="caps">JDK</span>.  Although the majority of the library is native (and uses the Android NDK) this is required to build the JAR and APK file at the end of the&nbsp;build.</p>
<p>To install, go to the Oracle <span class="caps">JDK</span> downloads page (<a href="http:&#x2F;&#x2F;www.oracle.com&#x2F;technetwork&#x2F;java&#x2F;javase&#x2F;downloads&#x2F;index.html">http:&#x2F;&#x2F;www.oracle.com&#x2F;technetwork&#x2F;java&#x2F;javase&#x2F;downloads&#x2F;index.html</a>) and download the latest <span class="caps">JDK</span> 1.6.  Note that JDK 7 will not work and you will get errors later on.  For the purpose of this tutorial I have been using Java SE Development Kit&nbsp;6u45.</p>
<p>As you are running server, you may need to download the <span class="caps">JDK</span> on another machine (where you will need to accept the license agreement) and then copy the .bin file to your Linux server (using either curl, wget, or VMWare shared&nbsp;folders).</p>
<p>Assuming the .bin file is in your home (~) directory, to install the <span class="caps">JDK</span>, perform the&nbsp;following:</p>
<p><code>cd &amp;#x2F;usr&amp;#x2F;lib&amp;#x2F;jvm &amp;amp;amp;&amp;amp;amp; sudo &amp;#x2F;bin&amp;#x2F;sh ~&amp;#x2F;jdk-6u45-linux-x64.bin -noregister</code></p>
<p>This will extract the <span class="caps">JDK</span> to the &#x2F;usr&#x2F;lib&#x2F;jvm directory.  After this is complete, we need to set the defaults to use the Oracle VM as opposed to the OpenJDK VM (which is installed by default).
<code>sudo update-alternatives --install &amp;#x2F;usr&amp;#x2F;bin&amp;#x2F;javac javac &amp;#x2F;usr&amp;#x2F;lib&amp;#x2F;jvm&amp;#x2F;jdk1.6.0_45&amp;#x2F;bin&amp;#x2F;javac 50000
sudo update-alternatives --install &amp;#x2F;usr&amp;#x2F;bin&amp;#x2F;java java &amp;#x2F;usr&amp;#x2F;lib&amp;#x2F;jvm&amp;#x2F;jdk1.6.0_45&amp;#x2F;bin&amp;#x2F;java 50000
sudo update-alternatives --config javac
sudo update-alternatives --config java</code></p>
<p>Finally, to overcome a small bug in the libjingle gwp compile scripts, we need to create a symbolic link:
<code>cd &amp;#x2F;usr&amp;#x2F;lib
ln -s jdk1.6.0_45 java-6-sun</code></p>
<p>After you&#39;ve done this, run the following&nbsp;command:</p>
<p><code>java -version</code></p>
<p>If you see &quot;Java HotSpot build 1.6.0_45&quot; instead of &quot;OpenJDK&quot;, the correct version of Java is install and you should be in good&nbsp;shape.</p>
<p><strong>Preparing for&nbsp;Compilation</strong></p>
<p>Before we compile, there are a few things that are required.  Firstly, we need to install some 32 bit compatibility libraries so that aapt and other Android compilation tools will function correctly.  To install, run the following&nbsp;command:</p>
<p><code>sudo apt-get install ia32-libs</code></p>
<p>Next, edit&nbsp;~&#x2F;libjingle&#x2F;trunk&#x2F;third_party&#x2F;webrtc&#x2F;build&#x2F;common.gypi</p>
<p>Navigate to the line that&nbsp;contains:</p>
<p><code>enable_tracing==0</code></p>
<p>and replace&nbsp;with:</p>
<p><code>enable_tracing==1</code></p>
<p>This will prevent the Android client from crashing (when it realizes it doesn&#39;t have a default trace file) and will make debugging the Android application a whole lot&nbsp;easier!</p>
<p>Finally, perform the following commands to complete preparation:
<code>cd ~&amp;#x2F;libjingle&amp;#x2F;trunk
.&amp;#x2F;build&amp;#x2F;install-build-deps-android.sh
. .&amp;#x2F;build&amp;#x2F;android&amp;#x2F;envsetup.sh</code></p>
<p>This will correctly setup the android dependencies.  Note the leading period on the envsetup script - this is very important as we need the variables to be set for the rest of the&nbsp;session.</p>
<p>Assuming these commands ran without errors, now&nbsp;run:</p>
<p><code>gclient runhooks</code></p>
<p>This command will generate the required ninja gwp compilation scripts.  After this,&nbsp;run:</p>
<p><code>android_gyp</code></p>
<p>You may get an error indicating that content.gyp could not be found - it is fine to ignore this for&nbsp;now.</p>
<p><strong>Compiling!</strong></p>
<p>If you&#39;ve reached this stage, congratulations!  We can now try to compile!  To do this, run the following command from the ~&#x2F;libjingle&#x2F;trunk&nbsp;directory:</p>
<p><code>ninja -C out&amp;#x2F;Debug -j 10 AppRTCDemo</code></p>
<p>This command is instructing the ninja compile tool to generate a debug version of the build, using a maximum of 10 concurrent build&nbsp;threads.</p>
<p>Depending on your machine, compilation will likely take about 10-15 minutes (time for that other coffee!).  Assuming everything went well, you should see some output in the ~&#x2F;libjingle&#x2F;trunk&#x2F;out&#x2F;Debug&nbsp;folder:</p>
<p><code>AppRTCDemo-debug.apk</code></p>
<p>This is the main demo&nbsp;<span class="caps">APK</span>.</p>
<p><code>libjingle_peerconnection.jar</code></p>
<p>This is the <span class="caps">JAR</span> for&nbsp;libjingle.</p>
<p><code>libjingle_peerconnection_so.so</code></p>
<p>This is the <span class="caps">ARM</span>-based native&nbsp;library.</p>
<p><strong>Running the <span class="caps">APK</span> on your&nbsp;device</strong></p>
<p>To run the <span class="caps">APK</span> on your device, copy the file to a machine with ADB installed (and your device connected) and run the following&nbsp;command:</p>
<p><code>adb -d install AppRTCDemo-debug.apk</code></p>
<p>If all goes well, you should see a new application called &quot;AppRTC&quot;.  To test the application, launch a new browser on your desktop (not on the phone!) and navigate to http:&#x2F;&#x2F;apprtc.appspot.com.  Enable access to your camera and microphone and note the room number of the conference&nbsp;window.</p>
<p>Now, launch the AppRTC application on your device and enter the room number as part of the <span class="caps">URL</span> (ensure that there are no spaces).  If all goes well you should have an established connection with video and audio between the browser and the mobile&nbsp;device!</p>
<p>If you run into issues (and this is quite complex, so it&#39;s usual) check <span class="caps">ADB</span> logcat for any errors and exceptions that are being produced by the AppRTC application.  Although functionally, this code is working, at the time of writing the TURN server being hosted on Google&#39;s Compute Cloud is having some issues - so I had to dive into the code and configure the application to use an alternative - but that&#39;s probably a good excuse for another post sometime in the&nbsp;future!</p>
<p>Either way, I hope this was useful and good&nbsp;luck!</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2014 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>