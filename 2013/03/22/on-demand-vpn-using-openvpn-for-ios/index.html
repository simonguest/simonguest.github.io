<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>On-Demand VPN using OpenVPN for iOS - simonguest.com
    </title>
    <link rel="alternate" href="//feed.xml" type="application/rss+xml" title="The only person allowed to login as 'guest'">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>On-Demand VPN using OpenVPN for iOS</h1>
        <p class="author">Written by <span class="author">Simon Guest</span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>Many large organizations have existing VPNs in place, and the rise in development of enterprise mobile applications often requires that apps running outside the firewall need to “<span class="caps">VPN</span> in” before they are allowed to access any corporate&nbsp;resources.</p>
<p>While enabling a <span class="caps">VPN</span> is fairly easy on most mobile devices, I’ve found that many IT organizations would like to automate this such that the device automatically connects to the VPN when the Enterprise App or an internal Website is launched. Having gone through this with a couple of customers, I’ve put this post together to highlight how this can be&nbsp;done.</p>
<p><span class="more"></span></p>
<p><strong>Which <span class="caps">VPN</span> types support On Demand for&nbsp;iOS?</strong></p>
<p>iOS 4.2 introduced features designed for the enterprise. These features included several <span class="caps">VPN</span> clients (L2TP, PPTP, Cisco IPSEC), many of which can be configured to automatically initiate the connection based upon DNS requests for certain&nbsp;domains.</p>
<p>While this on demand feature has been around for a while, it does have a couple of caveats. Firstly, it’s only available for <span class="caps">SSL</span> based VPNs. An SSL-based VPN is a connection that relies on a client/server side certificate for authentication. Having an SSL-based VPN means that the connection can be established without asking the user for credentials (e.g. a password or RSA token). Because an on-demand VPN could be connecting and disconnecting every few minutes, this makes sense as prompting the user could cause a jarring user experience. Secondly, the on demand VPN can only be setup using the iPhone Configuration utility. While you can create a VPN connection on iOS devices (under general/settings), it’s not possible to create an SSL-based VPN or specify any of the on demand&nbsp;domains.</p>
<p>With this in mind, I’ll be showing how to establish an On Demand <span class="caps">VPN</span> using OpenVPN and the OpenVPN client for iOS that was released earlier this&nbsp;year.</p>
<p><strong>Server-Side&nbsp;Setup</strong></p>
<p>The first step is of course to setup an OpenVPN server. If you don’t have access to one already, there are plenty of guides to help you set one up. If you don’t have access to a spare machine on the network, you can also use a Linux <span class="caps">VM</span> instance hosted on EC2, Azure, or any other hosting provider. This <a href="http://holgr.com/blog/2009/06/setting-up-openvpn-on-amazons-ec2/">article</a> is a pretty good guide for setting this up on <span class="caps">EC2</span> and the instructions should be able to be tailored to other hosting&nbsp;environments.</p>
<p><strong>Generating Certficates and&nbsp;Keys</strong></p>
<p>Once you have your OpenVPN server running, you’ll need to either import or generate certificates and keys required to establish the connection. If you don’t have access to certificates already, you can find some great documentation <a href="http://openvpn.net/index.php/open-source/documentation/howto.html">here</a> on how to create your own using the EasyRSA project on Github. (Scroll down and look for instructions on using&nbsp;easy-rsa)</p>
<p>These are the certificates you’ll need to generate using&nbsp;EasyRSA:</p>
<p><strong>ca.crt </strong>(<span class="caps">CA</span> certificate required for both server and client)
<strong>dh2048pem</strong> (A 2048bit Diffie Hellman key that is required on the server)
<strong>server.crt</strong> (The server-side certificate)
<strong>server.key</strong> (The key for the server-side certificate)
<strong>client1.crt</strong> (The client-side certificate)
<strong>client1.key</strong> (The key for the client-side&nbsp;certificate)</p>
<p><strong>Configuring&nbsp;OpenVPN </strong></p>
<p>Place the certificates in a folder called keys (under /etc/openvpn/keys) and modify your /etc/openvpn.conf file to look similar to the&nbsp;following:</p>
<pre><code>tls-server
port 443
proto tcp-server
dev tun
ifconfig 192.168.2.1 192.168.2.2
keepalive 10 120
comp-lzo
persist-key
persist-tun
verb 3
push &quot;ifconfig 192.168.2.2 192.168.2.1&quot;
push &quot;redirect-gateway&quot;
dh keys/dh2048.pem
ca keys/ca.crt
cert keys/server.crt
key keys/server.key
</code></pre><p>This should be fairly straightforward to understand from the documentation, especially if you’ve used OpenVPN before. As you can see, we are creating a peer to peer connection using two private <span class="caps">IP</span> addresses (192.168.2.1 and 192.168.2.2). Don’t worry if these don’t match your internal network on the OpenVPN box - they don’t need to in order to get this up and&nbsp;running.</p>
<p>For the purposes of this article, I have the <span class="caps">VPN</span> running on a tcp:443 connect, but feel free to adjust the protocol and port to match your own environment (assuming that you have the necessary ports open on your&nbsp;Firewall).</p>
<p>Once you have the server configured, you can start&nbsp;OpenVPN:</p>
<pre><code>openvpn --config /etc/openvpn/openvpn.conf
</code></pre><p>Assuming that the server starts <span class="caps">OK</span>, you can move to the next&nbsp;step.</p>
<p><strong>Installing and Configuring the&nbsp;Client</strong></p>
<p>The OpenVPN client can be found on the AppStore. At the time of writing it’s version 1.0 build 47, which has a few bugs here and here, but still seems to work&nbsp;well.</p>
<p>After you have this installed, go ahead and install the iPhone Configuration Utility on your Mac. This can be found on the Enterprise iPhone Support page (<a href="http://apple.com/support/iphone/enterprise">http://apple.com/support/iphone/enterprise</a>). Don’t worry - although it’s called the iPhone Configuration Utility, this will also work for setting up a <span class="caps">VPN</span> on an iPad device&nbsp;also.</p>
<p>After launching the utility, create a new configuration profile. In the general tab, enter the mandatory fields for name and identifier. Then, click on the credentials tab. We need to import the client certificate and key that was generated earlier using&nbsp;EasyRSA.</p>
<p>Unfortunately, the iPhone Configuration Utility (which we’ll call <span class="caps">IPCU</span> from now on) doesn’t support importing .CRT and .KEY files directly, so we’ll need to generate a PKCS#12 file for use here. To do this, in the Terminal locate your client certificate and key files, and run the following&nbsp;command:</p>
<pre><code>openssl pkcs12 -export -in client1.crt -inkey client1.key -out client1.p12
</code></pre><p>The result of this should be a .p12 file, that you can now import into the credentials section of&nbsp;<span class="caps">IPCU</span>.</p>
<p>Note:  When you generate the .p12 file, you will be asked for an export password for the file. Enter something, and use the same password in <span class="caps">IPCU</span> (there is a field just under the certificate picture). If you don’t enter a password, you will likely get a profile error when you try to deploy this to the&nbsp;device.</p>
<p>With this done, now navigate to the <span class="caps">VPN</span> tab and create a new VPN connection. IPCU doesn’t support including an OpenVPN config file, so we’ll have to create the majority of the settings in this tab - this is where things get fun&nbsp;:-)</p>
<p>Give the connection a name, and select “Custom <span class="caps">SSL</span>” for the connection type. For the identifier, use the&nbsp;following:</p>
<pre><code>net.openvpn.OpenVPN-Connect.vpnplugin
</code></pre><p>This is telling the <span class="caps">VPN</span> client that a specific bundle ID (the OpenVPN app) should be used for this&nbsp;connection.</p>
<p>Next, in the Server field, enter the <span class="caps">DNS</span> name or IP address for your OpenVPN&nbsp;server.</p>
<p>The Custom Data contains keys and strings that replicate what would have normally gone into a config.ovpn file. These are the entries that you will&nbsp;need:</p>
<p>ca - This is a tricky one to get right. We can’t point it to a ca.crt file, because there is no way of bundling a file using the <span class="caps">IPCU</span> tool. To overcome this, open the ca.crt file in TextEdit and replace all of the newline/carriage returns with n. What you should end up with is a single (long) line of text that starts with ——-BEGIN CERTIFICATE——- and has several lines delimitered by n ending with ——-END CERTIFICATE——-. Once you have this, paste this entire line into the value for the ca&nbsp;key.</p>
<p>comp-lzo - enter the key, but you don’t have to give it a&nbsp;value.</p>
<p>dev - set this to&nbsp;tun</p>
<p>port - set to&nbsp;443</p>
<p>proto - set to&nbsp;tcp</p>
<p>(Again if you are using something other than <span class="caps">TCP</span> port 443, feel free to&nbsp;change)</p>
<p>remote - set to [your server name]&nbsp;443</p>
<p>(replace your server name with the <span class="caps">DNS</span> name or IP address of your OpenVPN&nbsp;server)</p>
<p>verb - set to&nbsp;3</p>
<p>Here’s a quick screenshot of my&nbsp;profile:</p>
<p><img src="/articles/on-demand-vpn-using-openvpn-for-ios/profile.png" alt="Profile"></p>
<p>That should wrap up the custom data&nbsp;piece.</p>
<p>Under User Authentication, select Certificate - and then under Credential select the client certificate from the drop&nbsp;down.</p>
<p>Finally, check the “Enable <span class="caps">VPN</span> On Demand” box, and in the below table enter the domain names or IP addresses for the hosts that VPN is required for. For this tutorial, I have a single entry for 192.168.2.1 with “Always&nbsp;Establish”.</p>
<p><strong>That’s&nbsp;it!</strong></p>
<p>This configuration should be enough to get <span class="caps">VPN</span> On Demand working with OpenVPN on the iOS client. To test, deploy the configuration profile to the device. Assuming that this works, open a browser and browse to 192.168.2.1 - this should invoke the VPN connection and forward the requests to the OpenVPN server. If you have a test page running on the OpenVPN server then this should be displayed in the&nbsp;browser.</p>
<p><strong>If it didn’t&nbsp;work…</strong></p>
<p>There’s a good chance that things won’t work first time, just due the complexity of the setup.  Here are some of the common tips/tricks that I found during the&nbsp;process.</p>
<p>Firstly, the console window in <span class="caps">IPCU</span> will be your best friend. The most common error I saw was related to the CA certificate. If you get these, it likely means that your CA entry in IPCU is wrong. Go back and make sure you’ve correctly replaced the linebreaks with n’s and&nbsp;retest.</p>
<p>There are a few “bugettes” in the iOS client. As of build 47 these&nbsp;include:</p>
<ul>
<li><p>The tcp-client param is not supported in the iOS client. Use tcp&nbsp;instead.</p>
</li>
<li><p>The client expects ifconfig information to be pushed to it (using the push lines in the server config). It doesn’t seem to be possible to configure ifconfig lines&nbsp;locally.</p>
</li>
<li><p>The “redirect-gateway” seems to be required for the iOS client - whereas Tunnelblick connects without&nbsp;it.</p>
</li>
</ul>
<p>Workflow. Getting <span class="caps">VPN</span> On Demand working right off the bat can be hard, especially if multiple parts of the configuration are wrong. If you are new to OpenVPN, you might want to setup a VPN with a the following configurations (in terms of complexity just to get&nbsp;working):</p>
<ul>
<li>OpenVPN w/ Secret Key - using Desktop machine (use Tunnelblick for the&nbsp;Mac)</li>
<li>OpenVPN w/ Certificate - using Desktop&nbsp;machine</li>
<li>OpenVPN for iOS w/ Certificate - using the actual OpenVPN for iOS Client (not&nbsp;<span class="caps">IPCU</span>)</li>
<li>OpenVPN for iOS w/ Certificate - using&nbsp;<span class="caps">IPCU</span> </li>
</ul>
<p>Browser Refresh.  If it looks like everything is working (<span class="caps">VPN</span> established, etc.) but you still don’t get your Web page, try refreshing the browser/making a 2<span class="ord">nd</span> request.  I’m not sure whether this is something in the config, or a “feature” of the OpenVPN client for iOS - but I’ve found that refreshing often helps brings the page to life after the VPN connection has been&nbsp;established.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about"><p>Simon Guest is the VP of Platform R&amp;D at Concur Technologies, passionate about software engineering, API design, and developer experience.</p>
<p>Simon is a certified IT Architect (CITA-P), a member of the British Computer Society (MBCS), was named as one of “Microsoft’s Key Employee Losses of 2010″ by eWeek, and has been awarded a place on Sun Microsystems’ “Speaker Wall of Fame” on two occasions.</p>
<p>In addition to speaking, Simon enjoys writing, is the author of numerous articles, patents, and books, and maintains an active blog at <a href="http://simonguest.com">http://simonguest.com</a>.</p>
<p>You can get in touch with Simon through <a href="http://linkedin.com/pub/simonguest">LinkedIn</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2015 Simon Guest &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
            <script type="text/javascript">
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-56671816-1', 'auto');
              ga('send', 'pageview');
              
            </script>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>